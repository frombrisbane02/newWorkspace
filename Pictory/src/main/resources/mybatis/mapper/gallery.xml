<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

 <!-- 글한번올라갈때 테이블 채울거 필수: post, photo 선택: hashtag,map,text,product,museum 등 -->
 <!-- postNo, userNo, sNo, postTitle, postHits, postSellorNot, postCategory, postText, postLikes, postDate -->
<mapper namespace="mybatis.mapper.gallery">
	
	<!-- 필요 인자: 카테고리, 해시태그, 첫번째 이미지 url(썸네일용), 좋아요수, 댓글 수 -->
	<select id="galleryList" resultType="GalleryDTO">		
        SELECT po.postno,
      		po.postcategory,
            po.posttitle,
            u.usernickname,
            u.userprofile,
            u.userno,
            po.posthits,
            (SELECT COUNT(l.postNo) FROM LIKES l WHERE l.postno=po.postno) postLikes,
            (SELECT ph.photourl FROM photo ph WHERE ph.postno=po.postno AND ROWNUM = 1) photourl,
            (SELECT COUNT(ct.cno) FROM comment_tbl ct WHERE ct.postno=po.postno) commentCount
        FROM post po INNER JOIN users u
           ON po.userno = u.userno
     	ORDER BY po.postdate DESC
	</select>
	
	<select id="hashlist" resultType="GalleryDTO">
		SELECT h.hashtag, p.postno
		FROM HASHTAG h, POST p
		WHERE h.postno=p.postno
	</select>
	
	<select id="photoList" resultType="GalleryDTO" parameterType="_integer">
		SELECT photoUrl FROM PHOTO WHERE postNo=#{postNo}
	</select>
	
	<select id="galleryView" resultType="GalleryDTO" parameterType="_integer">
       SELECT po.postno,
      		po.postcategory,
            po.posttitle,
            po.postText,
            po.postDate,
            po.postSellorNot,
            u.usernickname,
            u.userprofile,
            u.userno,
            u.userId,
            po.posthits,
            po.postLikes,
            (SELECT COUNT(ct.cno) FROM comment_tbl ct WHERE ct.postno=po.postno) commentCount
        FROM post po INNER JOIN users u
           ON po.userno = u.userno
    	WHERE po.postNo=#{postNo}
	</select>
	
	<select id="userInfo" resultType="GalleryDTO" parameterType="_integer">
		SELECT (SELECT COUNT(p.postNo) FROM post p, users u WHERE p.userno=u.userno and u.userno=(SELECT p.userno FROM POST p WHERE p.postNo=#{postNo})) postCount,
			   (SELECT ph.photourl FROM photo ph WHERE ph.postno=p.postno AND ROWNUM = 1) photoUrl,
			   postNo
		 FROM post p INNER JOIN users u ON p.userno = u.userno
		 WHERE u.userno=(SELECT p.userno FROM POST p WHERE p.postNo=#{postNo})
     	ORDER BY p.postNo DESC
	</select>
	
	<!-- PostNo 가지고 댓글 목록(답글 포함) 가져오기 -->
	<select id="getComments" resultType="GalleryDTO" parameterType="_integer">
		SELECT c.cNo, c.userNo, c.cText, c.cLevel, c.cDate,c.parentCNo, u.userProfile, u.userNickname
		FROM USERS u, COMMENT_TBL c
		WHERE c.postNo=#{postNo} AND u.userNO=c.userNo
		ORDER BY c.cLevel
	</select>
	
	
</mapper>