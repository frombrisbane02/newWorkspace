<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="mybatis.mapper.gallery">
	
	<select id="feedGalleryList" parameterType="galleryDto" resultType="galleryDto">
		SELECT po.postno,
               po.posttitle,
               u.usernickname,
               u.userprofile,
               u.userno,
               po.posthits,
	           po.postlikes,
	           (SELECT ph.photourl FROM photo ph WHERE ph.postno=po.postno AND ROWNUM = 1) photourl,
	           (SELECT COUNT(ct.cno) FROM comment_tbl ct WHERE ct.postno=po.postno) commentcnt,
	           s.sno,
	           s.storytitle,
	           s.storythumbnail
		  FROM post po INNER JOIN users u
			ON po.userno = u.userno
	LEFT OUTER JOIN story s
			ON po.sno = s.sno
		 WHERE po.userno IN (SELECT followtargetid FROM follow WHERE userno = #{userNo})
	  ORDER BY po.postdate DESC
  	</select>
  	
  	<select id="galleryList" parameterType="Map" resultType="galleryDto">
		SELECT po.postno,
			   po.postcategory,
			   po.posttitle,
			   u.usernickname,
			   u.userprofile,
			   u.userno,
			   po.posthits,
			   po.postlikes,
			   (SELECT ph.photourl FROM photo ph WHERE ph.postno=po.postno AND ROWNUM = 1) photourl,
			   (SELECT COUNT(ct.cno) FROM comment_tbl ct WHERE ct.postno=po.postno) commentcnt,
			   s.sno,
			   s.storytitle,
			   s.storythumbnail
		  FROM post po INNER JOIN users u
	        ON po.userno = u.userno
	LEFT OUTER JOIN story s
			ON po.sno = s.sno
		 WHERE 1=1
		 <if test="postCategory !=null">
		   AND po.postcategory LIKE '%' || #{postCategory} || '%'
		 </if>
	  ORDER BY 
	  	 <choose>
	  	 	<when test="orderCode == 'postLikes'">po.postlikes DESC</when>
	  	 	<when test="orderCode == 'postHits'">po.posthits DESC</when>
	  	 	<otherwise>po.postdate DESC</otherwise>
	  	 </choose>
  	</select>
  	
  	<select id="storyList" parameterType="galleryDto" resultType="galleryDto">
  		SELECT st.sno,
  			   st.storytitle,
  			   st.storydescription,
  			   st.storythumbnail,
  			   st.userno 
  		  FROM(SELECT s.*,
  					  (SELECT po.userno FROM post po WHERE po.sno=s.sno AND ROWNUM = 1) AS userno
				 FROM story s)st
			    WHERE 1=1
		<if test="userNo !=null">
				  AND st.userno = #{userNo}
		</if>
		 ORDER BY st.sno DESC
  	</select>
  	
  	<select id="storyPictureList" parameterType="galleryDto" resultType="galleryDto">
  		SELECT ph.postno,
  			   ph.photono,
        	   ph.photourl,
        	   ph.photoname
		  FROM post po RIGHT OUTER JOIN photo ph
			ON po.postno=ph.photono
		 WHERE ph.postno IN(SELECT postno FROM post WHERE sno=#{sNo})
      ORDER BY ph.photono DESC
  	</select>
  	
  	
	
</mapper>